name: Build MKR Messenger

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode_15.0.app/Contents/Developer
        xcodebuild -version

    - name: Install Pods
      run: |
        sudo gem install cocoapods
        pod install

    - name: Build
      run: |
        xcodebuild -workspace deltachat-ios.xcworkspace \
          -scheme deltachat-ios \
          -sdk iphoneos \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create IPA
      run: |
        mkdir -p build

        # Создаем .app из build
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "deltachat-ios.app" | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "App not found, creating archive first..."
          xcodebuild -workspace deltachat-ios.xcworkspace \
            -scheme deltachat-ios \
            -sdk iphoneos \
            -archivePath build/MKR.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO || true
          APP_PATH=$(find build/MKR.xcarchive -name "deltachat-ios.app" | head -1)
        fi

        echo "App path: $APP_PATH"
        cp -r "$APP_PATH" build/ 2>/dev/null || echo "Copy failed, continuing..."

        # Создаем IPA структуру
        mkdir -p build/Payload
        if [ -d "build/deltachat-ios.app" ]; then
          cp -r build/deltachat-ios.app build/Payload/
          cd build
          zip -r MKRMessenger.ipa Payload/
          cd ..
        fi

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: MKR-Messenger
        path: build/MKRMessenger.ipa
        retention-days: 7

    - name: Summary
      run: |
        echo "## ✅ Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download IPA from artifacts below" >> $GITHUB_STEP_SUMMARY
